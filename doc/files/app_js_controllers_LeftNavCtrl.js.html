<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/controllers/LeftNavCtrl.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: app/js/controllers/LeftNavCtrl.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/client.html">client</a>
                                <ul>
                                        <li><a href="../modules/client.html#Controllers">Controllers</a></li>
                                </ul>
                            </li>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/ChartsCtrl.html">ChartsCtrl</a></li>
                            <li><a href="../classes/DeleteSource.html">DeleteSource</a></li>
                            <li><a href="../classes/DeleteZoneCtrl.html">DeleteZoneCtrl</a></li>
                            <li><a href="../classes/DialogCtrl.html">DialogCtrl</a></li>
                            <li><a href="../classes/FabCtrl.html">FabCtrl</a></li>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetFields.html">GetFields</a></li>
                            <li><a href="../classes/GetSources.html">GetSources</a></li>
                            <li><a href="../classes/GetStores.html">GetStores</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/HideBtnCtrl.html">HideBtnCtrl</a></li>
                            <li><a href="../classes/LeftNavCtrl.html">LeftNavCtrl</a></li>
                            <li><a href="../classes/LoaderCtrl.html">LoaderCtrl</a></li>
                            <li><a href="../classes/main.html">main</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MovableChartsCtrl.html">MovableChartsCtrl</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                            <li><a href="../classes/PutSource.html">PutSource</a></li>
                            <li><a href="../classes/RightNavCtrl.html">RightNavCtrl</a></li>
                            <li><a href="../classes/routes.html">routes</a></li>
                            <li><a href="../classes/server.html">server</a></li>
                            <li><a href="../classes/ToolBarCtrl.html">ToolBarCtrl</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_ChartsCtrl.js.html">ChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_DeleteZoneCtrl.js.html">DeleteZoneCtrl.js</a></li><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_FabCtrl.js.html">FabCtrl.js</a></li><li><a href="../files/app_js_controllers_HideBtnCtrl.js.html">HideBtnCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li><li><a href="../files/app_js_controllers_LoaderCtrl.js.html">LoaderCtrl.js</a></li><li><a href="../files/app_js_controllers_MovableChartsCtrl.js.html">MovableChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_RightNavCtrl.js.html">RightNavCtrl.js</a></li><li><a href="../files/app_js_controllers_ToolBarCtrl.js.html">ToolBarCtrl.js</a></li></ul></li><li><a href="../files/app_js_main.js.html">main.js</a></li></ul></li></ul></li><li>server.js/<ul></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_DeleteSource.js.html">DeleteSource.js</a></li><li><a href="../files/server_rest_GetFields.js.html">GetFields.js</a></li><li><a href="../files/server_rest_GetSources.js.html">GetSources.js</a></li><li><a href="../files/server_rest_GetStores.js.html">GetStores.js</a></li><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li><li><a href="../files/server_rest_PutSource.js.html">PutSource.js</a></li></ul></li><li><a href="../files/server_routes.js.html">routes.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/js/controllers/LeftNavCtrl.js</h4>

<pre class="code prettyprint linenums">
/**
 * Angualr.js controllers.
 * @module client
 * @submodule Controllers
 */

/**
 * A controller that serves all the left panel
 * in the &lt;code&gt;index.html&lt;/code&gt; view.
 * &lt;br/&gt;
 * It uses three custom angular services:
 * - &lt;b&gt;SourcesService&lt;/b&gt;: deals with getting/sendig/adding/deleting sources from/to/to/from the backend
 * - &lt;b&gt;StoresService&lt;/b&gt;: deals with getting stores from the backend
 * - &lt;b&gt;FieldsService&lt;/b&gt;: deals with getting fields from the backend
 * @class LeftNavCtrl
 */
angular.module(&#x27;MainApp&#x27;)
	.controller(&#x27;LeftNavCtrl&#x27;, function($scope, $rootScope, $mdDialog, $mdToast, SourcesService, StoresService, FieldsService){

		/**
		* @property stores_conf
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the left panel in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the store configs.
		*/
		$rootScope.stores_conf = [];

		/**
		* @property fields_conf
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the left panel in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the field configs.
		*/
		$rootScope.fields_conf = [];
	
		/**
		* @property sources_conf
		* @type array
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable,
		* binded to the left panel in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the source configs.
		*/
		$scope.sources_conf = [];

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that is used by 
		* &lt;b&gt;$rootScope.loadStores()&lt;/b&gt; to add the store configs from
		* the &lt;code&gt;stores_conf&lt;/code&gt; to the &lt;code&gt;$rootScope.stores_conf&lt;/code&gt; list.
		* @method addStores
		* @param {json array} stores_conf A list of store configs to add to the &lt;code&gt;$rootScope.stores_conf&lt;/code&gt; list
		*/
		$rootScope.addStores = function(stores_conf){

			stores_conf.forEach(function(store_conf, index){

				$rootScope.stores_conf.push(store_conf);
			});
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that removes the store configs
		* that are part of source config &lt;code&gt;source_conf&lt;/code&gt; from the
		* &lt;code&gt;$rootScope.sources_conf&lt;/code&gt; list.
		* @method removeStores
		* @param {json} source_conf Source config whoose store configs should be removed from the &lt;code&gt;$rootScope.sources_conf&lt;/code&gt; list
		*/
		$rootScope.removeStores = function(source_conf){

			//get the indexes and clear the fields
			var indexes = [];
			$rootScope.stores_conf.forEach(function(store_conf, index){

				if (store_conf.source.name === source_conf.source.name){
					
					$rootScope.removeFields(store_conf);
					indexes.push(index);
				}
			});

			//remove sources
			indexes.forEach(function(index, i){

				$rootScope.stores_conf.splice(index - i, 1);
			});
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that clears the 
		* &lt;code&gt;$rootScope.stores_conf&lt;/code&gt; list.
		* @method clearStores
		*/
		$rootScope.clearStores = function(){

			$rootScope.stores_conf = [];
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that is used by 
		* &lt;b&gt;$rootScope.loadFields()&lt;/b&gt; to add the field configs from
		* the &lt;code&gt;fields_conf&lt;/code&gt; to the &lt;code&gt;$rootScope.fields_conf&lt;/code&gt; list.
		* @method addFields
		* @param {json array} fields_conf A list of field configs to add to the &lt;code&gt;$rootScope.fields_conf&lt;/code&gt; list
		*/
		$rootScope.addFields = function(fields_conf){

			fields_conf.forEach(function(field_conf, index){

				$rootScope.fields_conf.push(field_conf);
			});
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that removes the field configs
		* that are part of store config &lt;code&gt;store_conf&lt;/code&gt; from the
		* &lt;code&gt;$rootScope.fields_conf&lt;/code&gt; list.
		* @method removeFields
		* @param {json} store_conf Store config whoose field configs should be removed from the &lt;code&gt;$rootScope.fields_conf&lt;/code&gt; list
		*/		
		$rootScope.removeFields = function(store_conf){

			//get the indexes
			var indexes = [];
			$rootScope.fields_conf.forEach(function(field_conf, index){

				if (field_conf.store.name === store_conf.store.name)
					indexes.push(index);
			});

			//remove sources
			indexes.forEach(function(index, i){

				$rootScope.fields_conf.splice(index - i, 1);
			});	
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that clears the 
		* &lt;code&gt;$rootScope.fields_conf&lt;/code&gt; list.
		* @method clearFields
		*/
		$rootScope.clearFields = function(){

			$rootScope.fields_conf = [];
		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that is 
		* using a &lt;b&gt;SourcesService&lt;/b&gt; service to query
		* a list of source configs from the back-end and
		* loads it to the &lt;code&gt;$scope.sources_conf&lt;/code&gt;
		* @method loadSources
		*/
		$rootScope.loadSources = function(){

			//show the progress bar
			$rootScope.showPB(true);

			//loading
			SourcesService.query(
				function(sources_conf){

					//set source configs
					$scope.sources_conf = sources_conf;
					$rootScope.showPB(false);
				},
				function(err){

					$rootScope.showPB(false);
					if (!err.data) err.data = &#x27;Server is unreachable&#x27;;
					
					$mdToast.show(

						$mdToast.simple()
							.textContent(err.data)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);
				}
			);
		}

		//automatically load the sources
		$rootScope.loadSources();

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that is using
		* the &lt;b&gt;StoresServie&lt;/b&gt; service to query
		* a list of store configs that are part 
		* of the source config &lt;code&gt;source_conf&lt;/code&gt;.
		* Then by using the &lt;b&gt;$rootScope.addStores()&lt;/b&gt; method
		* it adds them to the &lt;code&gt;$rootScope.stores_conf&lt;/code&gt;.
		* @method loadStores
		* @param {json} source_conf A source config whoose stores configs should be loaded
		*/
		$rootScope.loadStores = function(source_conf){

			if (source_conf.source.wanted){

				//show the progress bar
				$rootScope.showPB(true);

				//load a store
				//input is an array of sources
				StoresService.post([source_conf], 
					function(stores_conf){

						//add a short store name
						var store_name;
						stores_conf.forEach(function(store_conf, index){

							store_name = store_conf.store.name;
							store_conf.store.short = (store_name.length &gt; 15) ? store_name.slice(0,15) + &#x27;..&#x27; : store_name;
						});

						//add to the stores list
						$rootScope.addStores(stores_conf);
						$rootScope.showPB(false);

					},
					function(err){

						$rootScope.showPB(false);
						if (!err.data) err.data = &#x27;Server is unreachable&#x27;;

						$mdToast.show(
							$mdToast.simple()
								.textContent(err.data)
								.action(&#x27;OK&#x27;)
								.position(&#x27;bottom&#x27;)
								.hideDelay(4000)
						);
					}
				);
			}else{

				$rootScope.removeStores(source_conf);
			}

		}

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that returns
		* a formatted name of the type of source specified
		* by &lt;code&gt;source_conf&lt;/code&gt;.
		* @method getSourceType
		* @param {json} source_conf A source config to get the type from
		* @return {string} A type name
		*/
		$scope.getSourceType = function(source_conf){

			var types = {

				mongo: &#x27;MongoDB&#x27;,
				mysql: 	&#x27;MySQL&#x27;,
				json: &#x27;JSON&#x27;,
				csv: &#x27;CSV&#x27;
			};

			return types[source_conf.source.type];
		}

		//dialog to modify the source
		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that launches
		* a dialog to modify a source config.
		* &lt;br/&gt;
		* The template used by dialog is &lt;code&gt;AddSource.html&lt;/code&gt;.
		* @method modifySource
		* @param event Event
		* @param {json} source_conf A source config to modify
		*/
		$scope.modifySource = function(event, source_conf){

			//used to pass data to the 
			//DialogController
			var shareSourceCtrl = function ($scope, source_conf) {

				$scope.source_conf = source_conf;
			}

			$mdDialog.show({

				templateUrl: &#x27;../../templates/AddSource.html&#x27;,
				parent: angular.element(document.body),
				targetEvent: event,
				clickOutsideToClose: true,
				controller: shareSourceCtrl,
				locals: {&#x27;source_conf&#x27;: source_conf}
			});
		};

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that is using 
		* a &lt;code&gt;FieldsService&lt;/code&gt; service to query
		* a list of field config that are part of the 
		* store config &lt;code&gt;store_config&lt;/code&gt;.
		* Then by using the &lt;b&gt;$rootScope.addFields()&lt;/b&gt; method
		* it adds them to the &lt;code&gt;$scope.fields_conf&lt;/code&gt;.
		* @method loadFields
		* @param {json} store_conf A store config whoose field configs should be loaded into &lt;code&gt;$scope.fields_conf&lt;/code&gt;
		*/
		$scope.loadFields = function(store_conf) {

			if (store_conf.wanted){

				//launch the progress bar
				$rootScope.showPB(true);

				//load the stores fields
				FieldsService.post([store_conf], 
					function(fields_conf){

						//process each field
						fields_conf.forEach(function(field_conf, index){

							//dataset is not loaded yet
							field_conf.field.status = &#x27;ready&#x27;;

							//check the field name
							field_conf.field.short = (field_conf.field.name.length &gt; 6) ? field_conf.field.name.slice(0,6) + &#x27;..&#x27; : field_conf.field.name;
						});

						//add the fields to the list
						$rootScope.addFields(fields_conf);
						$rootScope.showPB(false);

					});

			}
			else{

				$rootScope.removeFields(store_conf);
			}

		};

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that is 
		* called by clicking on the &#x27;clear all&#x27; link
		* on the left panel. It clears all the 
		* choosen sources, stores and fields.
		* @method clear
		*/
		$scope.clear = function(){

			//set the sources as unwanted
			$scope.sources_conf.forEach(function(source_conf, index){

				source_conf.source.wanted = false;
			});

			//clear stores and fields list
			$rootScope.clearStores();
			$rootScope.clearFields();
		}

	})
</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
