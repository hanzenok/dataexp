<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/controllers/ChartsCtrl.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: app/js/controllers/ChartsCtrl.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/client.html">client</a>
                                <ul>
                                        <li><a href="../modules/client.html#Controllers">Controllers</a></li>
                                </ul>
                            </li>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/ChartsCtrl.html">ChartsCtrl</a></li>
                            <li><a href="../classes/DeleteSource.html">DeleteSource</a></li>
                            <li><a href="../classes/DeleteZoneCtrl.html">DeleteZoneCtrl</a></li>
                            <li><a href="../classes/DialogCtrl.html">DialogCtrl</a></li>
                            <li><a href="../classes/FabCtrl.html">FabCtrl</a></li>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetFields.html">GetFields</a></li>
                            <li><a href="../classes/GetSources.html">GetSources</a></li>
                            <li><a href="../classes/GetStores.html">GetStores</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/HideBtnCtrl.html">HideBtnCtrl</a></li>
                            <li><a href="../classes/LeftNavCtrl.html">LeftNavCtrl</a></li>
                            <li><a href="../classes/LoaderCtrl.html">LoaderCtrl</a></li>
                            <li><a href="../classes/main.html">main</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MovableChartsCtrl.html">MovableChartsCtrl</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                            <li><a href="../classes/PutSource.html">PutSource</a></li>
                            <li><a href="../classes/RightNavCtrl.html">RightNavCtrl</a></li>
                            <li><a href="../classes/routes.html">routes</a></li>
                            <li><a href="../classes/server.html">server</a></li>
                            <li><a href="../classes/ToolBarCtrl.html">ToolBarCtrl</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_ChartsCtrl.js.html">ChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_DeleteZoneCtrl.js.html">DeleteZoneCtrl.js</a></li><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_FabCtrl.js.html">FabCtrl.js</a></li><li><a href="../files/app_js_controllers_HideBtnCtrl.js.html">HideBtnCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li><li><a href="../files/app_js_controllers_LoaderCtrl.js.html">LoaderCtrl.js</a></li><li><a href="../files/app_js_controllers_MovableChartsCtrl.js.html">MovableChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_RightNavCtrl.js.html">RightNavCtrl.js</a></li><li><a href="../files/app_js_controllers_ToolBarCtrl.js.html">ToolBarCtrl.js</a></li></ul></li><li><a href="../files/app_js_main.js.html">main.js</a></li></ul></li></ul></li><li>server.js/<ul></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_DeleteSource.js.html">DeleteSource.js</a></li><li><a href="../files/server_rest_GetFields.js.html">GetFields.js</a></li><li><a href="../files/server_rest_GetSources.js.html">GetSources.js</a></li><li><a href="../files/server_rest_GetStores.js.html">GetStores.js</a></li><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li><li><a href="../files/server_rest_PutSource.js.html">PutSource.js</a></li></ul></li><li><a href="../files/server_routes.js.html">routes.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/js/controllers/ChartsCtrl.js</h4>

<pre class="code prettyprint linenums">
/**
 * Angualr.js controllers.
 * @module client
 * @submodule Controllers
 */

/**
 * A controller that serves 
 * the container of DC.js and Canvas.js charts
 * in the &lt;code&gt;index.html&lt;/code&gt; view.
 * &lt;br/&gt;
 * It uses two custom angular services:
 * - &lt;b&gt;DCChartsService&lt;/b&gt;: generates the DC.js charts
 * - &lt;b&gt;CanvasChartsService&lt;/b&gt;: generates the Canvas.js charts
 *
 * It defines three methods which should be explained:
 * - &lt;b&gt;renderAll()&lt;/b&gt;: a method that launches automatically
 * when all the DOM elements needed for rendering all 
 * the charts from the &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt; list where generated
 * (but charts not yet traced). This is done by using angular &lt;code&gt;$last&lt;/code&gt; directive.
 * When the method is launched, if the boolean &lt;code&gt;$scope.reload&lt;/code&gt; is true, it traces
 * all the charts from the &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt; list.
 * It is done this way, because in order to trace a DC.js or Canvas.js charts,
 * all the DOM containers (divs) should be already present (and we are generating them progrmatically).
 * - &lt;b&gt;onDropChart()&lt;/b&gt;: a method that traces only one chart, when the &#x27;movable chart&#x27;
 * is dropped to the charts container. It also adds it to the &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt;
 * list, which will trigger automatically the &lt;b&gt;renderAll()&lt;/b&gt; function, that will retrace all
 * for the second time. To prevent this, the &lt;b&gt;onDropChart()&lt;/b&gt; method sets the variable 
 * &lt;code&gt;$scope.reload&lt;/code&gt; to false.
 * - &lt;b&gt;reloadCharts()&lt;/b&gt;: a method that reloads all the DOM elements chart containers,
 * and then reintroduces them. Which triggers the &lt;b&gt;renderAll()&lt;/b&gt; method that traces all the 
 * charts. To allow it, the &lt;b&gt;reloadCharts()&lt;/b&gt; sets the variable &lt;code&gt;$scope.reload&lt;/code&gt; to true.
 * @class ChartsCtrl
 */
angular.module(&#x27;MainApp&#x27;)
	.controller(&#x27;ChartsCtrl&#x27;, function ($scope, $rootScope, $http, $mdToast, DCChartsService, CanvasChartsService) {

		//chart types
		var EnumCharts = {
							pie: &#x27;Pie&#x27;,
							timeline: &#x27;Timeline&#x27;,
							scatter: &#x27;Scatter&#x27;,
							row: &#x27;Row&#x27;,
							bar: &#x27;Bar&#x27;
						};
		/**
		* @property reload
		* @type boolean
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable
		* that is used to trigger (or not)
		* the &lt;b&gt;renderAll()&lt;/b&gt; method
		* to reload all the charts.
		*/
		$scope.reload = false;

		/**
		* @property hideTitle
		* @type boolean
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable
		* that is used to show/hide
		* the message &#x27;Rendering ...&#x27; while
		* the chart (DC.js or Canvas.js) is rendering.
		*/		
		$scope.hideTitle = false; //&#x27;Rendering ...&#x27; title

		/**
		* @property droppedCharts
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable
		* that holds all the dropped movable charts
		* on the charts container in the &lt;code&gt;index.html&lt;/code&gt;.
		*/
		$rootScope.droppedCharts = []; //dropped charts container

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that fires
		* when a movable chart is dropped on the 
		* charts container in the &lt;code&gt;index.html&lt;/code&gt;
		* and traces a chart (DC.js or Canvas.js).
		* @method onDropChart
		* @param data Dropped object
		*/
		$scope.onDropChart = function(data){

			//if dropped is a movable chart
			if (data &amp;&amp; data.chart &amp;&amp; $rootScope.chartFields.length){

				//to show to the $scope.renderAll function
				//that we are adding a new chart
				//and not reloading all the charts
				$scope.reload = false;

				//show title
				$scope.hideTitle = false;

				//launch the progress bar
				$rootScope.showPB(true);

				//filtering all the dropped fields
				//by chart type
				var filtered_fields = [];
				var fields = $rootScope.chartFields;
				var n = fields.length;
				for (var i=0; i&lt;n; i++){

					if (fields[i].chart === data.chart){
						
						filtered_fields.push(fields[i]);
					}
				}

				//checks
				var error_message = &#x27;&#x27;;
				var nb_fields = filtered_fields.length;
				if (nb_fields &gt; 2)
					error_message = data.chart + &#x27;Chart should have 1 or 2 fields&#x27;;

				if (data.chart === EnumCharts.scatter &amp;&amp; nb_fields !== 2)
					error_message = data.chart + &#x27;Plot should have 2 fields&#x27;;

				if ($rootScope.force_canvasjs || $rootScope.size_status === &#x27;overflow&#x27;){

					if (nb_fields &gt; 1 &amp;&amp; (data.chart === EnumCharts.pie || data.chart === EnumCharts.row))
						error_message = &#x27;Canvas.js PieChart and RowChart should have only 1 field&#x27;;

					if (nb_fields &gt; 1 &amp;&amp; data.chart === EnumCharts.bar){

						//check for the timestamp fields
						error_message = &#x27;Canvas.js BarChart should have only 1 &#x27;;// non-timestamp field&#x27;;
						for(var i=0; i&lt;n; i++){

							if (filtered_fields[i].field.format){

								error_message += &#x27;non-timestamp &#x27;;
								break;
							}
						}
						error_message += &#x27;field&#x27;;
					}

					if (nb_fields === 1 &amp;&amp; data.chart === EnumCharts.bar &amp;&amp; filtered_fields[0].field.format){

						error_message = &#x27;Canvas.js BarChart should have only non-timestamp field&#x27;;
					}
				}

				if (error_message){

					//stop the progress bar
					$rootScope.$apply(function(){
						$rootScope.showPB(false);
					});

					$mdToast.show(
						$mdToast.simple()
							.textContent(error_message)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);

					return;
				}	

				//create chart object
				var chart_config = {};
				chart_config.id = &#x27;chart_&#x27; + Math.floor(Math.random()*2000); //random dom id
				chart_config.type = data.chart;
				chart_config.key1 = filtered_fields[0].field.name;
				chart_config.key2 = (filtered_fields[1]) ? filtered_fields[1].field.name : null;
				chart_config.ts_key = (data.chart === EnumCharts.timeline || data.chart === EnumCharts.bar) ? &#x27;time&#x27; : null; //timestamp key

				//check if user added a timestamp to the barchart
				//this timestamp is different from ts_key because
				//it is a key before the dataset goes throug tsproc
				if (chart_config.type === EnumCharts.bar){

					//first key
					if(filtered_fields[0].field.format){

						chart_config.key1 = chart_config.ts_key;
					}

					//or second
					if (chart_config.key2 &amp;&amp; filtered_fields[1].field.format){

						chart_config.key2 = chart_config.ts_key;
					}
				}

				//add to the charts list
				$rootScope.droppedCharts.push(chart_config);

				//wait for the DOM elements
				//to be added then trace
				setTimeout(function() {

					var chart_service = ($rootScope.size_status === &#x27;overflow&#x27; || $rootScope.force_canvasjs) ? CanvasChartsService : DCChartsService;
					var chart = chart_service.traceOne(chart_config.type, chart_config.id, chart_config.key1, chart_config.key2, chart_config.ts_key);
					chart.render();

					//hide the title
					$scope.hideTitle = true;

					//stop the progress bar
					$rootScope.$apply(function(){
						$rootScope.showPB(false);
					});

				}, 300);
			}


		}

		/**
		* A &lt;b&gt;root scope&lt;/b&gt; method that fires
		* on clicking the FAB button in the main 
		* container. It reloads all the charts (DC.js or Canvas.js)
		* from the &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt;.
		* @method reloadCharts
		*/
		$rootScope.reloadCharts = function(){

			//copy the charts before cleaning
			var new_charts = [];
			$rootScope.droppedCharts.forEach(function(chart, index){

				new_charts.push(chart);
			});

			//drop the list of charts to clear
			//up the DOM elements
			$rootScope.droppedCharts = [];

			//wait for the dom elements to be deleted
			setTimeout(function() {

					//load the data
					var chart_service = ($rootScope.size_status === &#x27;overflow&#x27; || $rootScope.force_canvasjs) ? CanvasChartsService : DCChartsService;
					chart_service.load($rootScope.dataset, function(err){

						if (err){
							$mdToast.show(
								$mdToast.simple()
									.textContent(err.message)
									.action(&#x27;OK&#x27;)
									.position(&#x27;bottom&#x27;)
									.hideDelay(4000)
							);
						}
					});

					//to inform the $scope.renderAll function
					//that we are reloading
					$scope.reload = true;

					//reintroduce the charts list
					$rootScope.$apply(function () {
						$rootScope.droppedCharts = new_charts;
					});

			}, 300);
		}


		//launched when the list of charts in the DOM
		//is finished generating
		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that
		* launches automatically when all the DOM
		* elements-containers for charts from the 
		* &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt; where generated.
		* When launched, it traces all the charts from the &lt;code&gt;$rootScope.droppedCharts&lt;/code&gt;
		* list.
		* @method renderAll
		*/
		$scope.renderAll = function(){

			//check if we are reloading all the charts
			//if not this function would be launched during
			//the chart dropps
			if ($scope.reload){

				//show title
				$scope.hideTitle = false;

				//launch the progress bar
				$rootScope.showPB(true);

				//wait for the dom
				setTimeout(function(){

					//render all charts
					var chart_service = ($rootScope.size_status === &#x27;overflow&#x27; || $rootScope.force_canvasjs) ? CanvasChartsService : DCChartsService;
					$rootScope.droppedCharts.forEach(function(chart_config, index){

						var chart = chart_service.traceOne(chart_config.type, chart_config.id, chart_config.key1, chart_config.key2, chart_config.ts_key);
						chart.render();
					});

					//hide the title
					$scope.hideTitle = true;

					//stop the progress bar
					$rootScope.$apply(function(){
						$rootScope.showPB(false);
					});
					

				}, 300);
			}
		}

	});
</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
