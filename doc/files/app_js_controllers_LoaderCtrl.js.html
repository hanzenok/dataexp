<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/controllers/LoaderCtrl.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: app/js/controllers/LoaderCtrl.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/client.html">client</a>
                                <ul>
                                        <li><a href="../modules/client.html#Controllers">Controllers</a></li>
                                </ul>
                            </li>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/ChartsCtrl.html">ChartsCtrl</a></li>
                            <li><a href="../classes/DeleteSource.html">DeleteSource</a></li>
                            <li><a href="../classes/DeleteZoneCtrl.html">DeleteZoneCtrl</a></li>
                            <li><a href="../classes/DialogCtrl.html">DialogCtrl</a></li>
                            <li><a href="../classes/FabCtrl.html">FabCtrl</a></li>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetFields.html">GetFields</a></li>
                            <li><a href="../classes/GetSources.html">GetSources</a></li>
                            <li><a href="../classes/GetStores.html">GetStores</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/HideBtnCtrl.html">HideBtnCtrl</a></li>
                            <li><a href="../classes/LeftNavCtrl.html">LeftNavCtrl</a></li>
                            <li><a href="../classes/LoaderCtrl.html">LoaderCtrl</a></li>
                            <li><a href="../classes/main.html">main</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MovableChartsCtrl.html">MovableChartsCtrl</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                            <li><a href="../classes/PutSource.html">PutSource</a></li>
                            <li><a href="../classes/routes.html">routes</a></li>
                            <li><a href="../classes/server.html">server</a></li>
                            <li><a href="../classes/ToolBarCtrl.html">ToolBarCtrl</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_ChartsCtrl.js.html">ChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_DeleteZoneCtrl.js.html">DeleteZoneCtrl.js</a></li><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_FabCtrl.js.html">FabCtrl.js</a></li><li><a href="../files/app_js_controllers_HideBtnCtrl.js.html">HideBtnCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li><li><a href="../files/app_js_controllers_LoaderCtrl.js.html">LoaderCtrl.js</a></li><li><a href="../files/app_js_controllers_MovableChartsCtrl.js.html">MovableChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_ToolBarCtrl.js.html">ToolBarCtrl.js</a></li></ul></li><li><a href="../files/app_js_main.js.html">main.js</a></li></ul></li></ul></li><li>server.js/<ul></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_DeleteSource.js.html">DeleteSource.js</a></li><li><a href="../files/server_rest_GetFields.js.html">GetFields.js</a></li><li><a href="../files/server_rest_GetSources.js.html">GetSources.js</a></li><li><a href="../files/server_rest_GetStores.js.html">GetStores.js</a></li><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li><li><a href="../files/server_rest_PutSource.js.html">PutSource.js</a></li></ul></li><li><a href="../files/server_routes.js.html">routes.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/js/controllers/LoaderCtrl.js</h4>

<pre class="code prettyprint linenums">
/**
 * Angualr.js controllers.
 * @module client
 * @submodule Controllers
 */

/**
 * A controller that serves loader zone
 * in the footer of &lt;code&gt;index.html&lt;/code&gt; view.
 * &lt;br/&gt;
 * It uses three custom angular services:
 * - &lt;b&gt;TimeseriesService&lt;/b&gt;: deals with getting the timeseries, &lt;code&gt;tsproc&lt;/code&gt; config and timeseries statistics from the back-end
 * - &lt;b&gt;DCChartService&lt;/b&gt;: used to load data to the DC.js charting library 
 * - &lt;b&gt;CanvasChartService&lt;/b&gt;: used to load data to the Canvas.js charting library
 * @class LoaderCtrl
 */
angular.module(&#x27;MainApp&#x27;)
	.controller(&#x27;LoaderCtrl&#x27;, function($scope, $rootScope, $mdDialog, $mdToast, TimeseriesService, DCChartsService, CanvasChartsService){

		/**
		* @property droppedFields
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the footer in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the list of dropped field configs
		* to the area &#x27;Fields&#x27; of the loader.
		*/
		$rootScope.droppedFields = [];

		/**
		* @property droppedTSFields
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the footer in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the list of dropped timestamp field configs
		* to the area &#x27;Timestamp Fields&#x27; of the loader.
		*/
		$rootScope.droppedTSFields = [];

		/**
		* @property chartFields
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the footer in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the list of dropped field configs
		* to the &#x27;movable charts&#x27; area.
		*/
		$rootScope.chartFields = [];

		/**
		* @property dataset
		* @type array
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the in the &lt;code&gt;index.html&lt;/code&gt; view,
		* that holds the loaded from the back-end dataset.
		*/
		$rootScope.dataset = [];

		/**
		* @property loaded
		* @type boolean
		* @description A &lt;b&gt;root scope&lt;/b&gt; variable,
		* binded to the &lt;code&gt;index.html&lt;/code&gt; view,
		* that sets the state of dataset, wheather it is 
		* loaded or not.
		*/
		$rootScope.loaded = false;

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that is launched
		* when the field config is dropped into the &#x27;Fields&#x27; area.
		* Then it adds it to the &lt;code&gt;$rootScope.droppedFields&lt;/code&gt;.
		* @method onDropComplete
		* @param {json} data Dropped field config
		*/
		$scope.onDropComplete = function(data){

			//if dropped object is a field
			if (data.field){

				//find if exists
				var index = $rootScope.droppedFields.indexOf(data);

				//if not exists
				if (index == -1){

					//add the quantification field
					data.field.quantum = 0;

					//add
					$rootScope.droppedFields.push(data);
				}
			}		
		};

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that is launched
		* when the field config is dropped into the &#x27;Timestamp Fields&#x27; area.
		* Then it adds it to the &lt;code&gt;$rootScope.droppedTSFields&lt;/code&gt;.
		* @method onTSDropComplete
		* @param {json} data Dropped field config
		*/
		$scope.onTSDropComplete = function(data){

			//if dropped object is a field
			if (data.field){

				//copy the object
				var clone = JSON.parse(JSON.stringify(data));

				//check the index
				var index = -1;
				var n = $rootScope.droppedTSFields.length;
				for (var i=0; i&lt;n; i++){

					if (clone.field.name === $rootScope.droppedTSFields[i].field.name &amp;&amp; 
						clone.store.name === $rootScope.droppedTSFields[i].store.name &amp;&amp;
						clone.source.name === $rootScope.droppedTSFields[i].source.name){

						index = i;
						break
					}
				}
				
				//if not exists
				if (index == -1){

					//used to pass data to the 
					//DialogController
					var shareFieldCtrl = function ($scope, data) {

						$scope.data = data;
					}

					//ask the format of the timestamp field
					$mdDialog.show({
						templateUrl: &#x27;../../templates/SaveFormat.html&#x27;,
						parent: angular.element(document.body),
						clickOutsideToClose: false,
						controller: shareFieldCtrl,
						locals: {data: clone}
					})
					.then(function(format){

						//set the format
						clone.field.format = format;
					});
				
					//add asynchroniously
					$rootScope.droppedTSFields.push(clone);

				}
			}	
		};

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that is fired
		* when the download button in the loader zone is clicked.
		* It uses the &lt;b&gt;TimeseriesService&lt;/b&gt; to pass all the 
		* field configs and option to the backend, and then 
		* it receives a dataset with all the queried fields.
		* On the back-end side, this request goes through &lt;code&gt;tsproc&lt;/code&gt;
		* module.
		* &lt;br/&gt;
		* It initiates one of the charting libraries (either by
		* DCChartsService or CanvasChartsService) withe loaded dataset.
		* &lt;br/&gt;
		* The method also lets the &lt;code&gt;tsproc&lt;/code&gt; configuration json
		* to be downloadable, as well as loaded dataset (as a json).
		*/
		$scope.load = function(){

			var timestamps = $rootScope.droppedTSFields;
			var fields = $rootScope.droppedFields;

			if (timestamps.length &amp;&amp; fields.length){

				//show the progressbar
				$rootScope.showPB(true);

				//get the options
				var options = $rootScope.getOptions();

				//mark all the quantum of all the timestamps
				timestamps.forEach(function(ts_config, index){

					ts_config.field.quantum = options.tsfield_quantum;
				});

				//compose all the options and all the fields that needs to be downloaded into one
				var all_fields_conf = [
										options,
										timestamps, 
										fields
									];

				//send them to the server
				TimeseriesService.post(all_fields_conf, 
					function(data){

						//hide the progressbar
						$rootScope.showPB(false);

						//data has at least two elements
						//(one is promise related)
						if (data &amp;&amp; data.length &gt; 2){

							//save data
							$rootScope.dataset = data;

							//load and set the stats
							TimeseriesService.stats(function(stats){

								var stat = stats[0];
								$rootScope.setStats(stat);
							});

							//load the config
							TimeseriesService.config(function(ts_config){

								//delete unnecessary frontend fields:
								ts_config[0].timeseries.forEach(function(ts, index){

									//delete timestamp fields
									delete ts.timestamp.short;
									delete ts.timestamp.status;
									delete ts.timestamp.value;

									//delete other fields
									ts.fields.forEach(function(field, index){

										delete field.short;
										delete field.status;
										delete field.value;
									});
								});

								//let the config to be downloadable
								var config = JSON.stringify(ts_config[0], null, 4);
								var blob = new Blob([config], {type: &#x27;text/json&#x27;});
								$scope.url = (window.URL || window.webkitURL).createObjectURL(blob);

								//=================================
								//NOT CONFIG RELATED STUFF BUT
								//SHOULD BE LAUNCHED SYNCHRONIOUSLY
								//=================================

								//let the dataset to be downloadable
								var dataset = JSON.stringify($rootScope.dataset, null, 4);
								var blob2 = new Blob([dataset], {type: &#x27;text/json&#x27;});
								$rootScope.url = (window.URL || window.webkitURL).createObjectURL(blob2);

								//load data into the charting library
								var chart_service = ($rootScope.size_status === &#x27;overflow&#x27; || $rootScope.force_canvasjs) ? CanvasChartsService : DCChartsService;
								chart_service.load($rootScope.dataset, function(err){

									if (err){
										$mdToast.show(
											$mdToast.simple()
												.textContent(err.message)
												.action(&#x27;OK&#x27;)
												.position(&#x27;bottom&#x27;)
												.hideDelay(4000)
										);
									}
								});

								//if there are some charts, reload them
								if ($rootScope.droppedCharts.length){

									$rootScope.reloadCharts();
								}

								//mark as loaded
								$rootScope.loaded = true;

								//mark all the fields as loaded					
								//time stamp fields
								all_fields_conf[1].forEach(function(tsfield_conf, index){
									tsfield_conf.field.status = &#x27;loaded&#x27;;
								});

								//other fields
								all_fields_conf[2].forEach(function(field_conf, index){
									field_conf.field.status = &#x27;loaded&#x27;;
								});

							});

						}

					},
					function(err){

						$rootScope.showPB(false);
						if (!err.data) err.data = &#x27;Server is unreachable&#x27;;
						
						$mdToast.show(
							$mdToast.simple()
								.textContent(err.data)
								.action(&#x27;OK&#x27;)
								.position(&#x27;bottom&#x27;)
								.hideDelay(4000)
						);
					});
			}
			else{

				$mdToast.show(
					$mdToast.simple()
						.textContent(&#x27;No fields are specified&#x27;)
						.action(&#x27;OK&#x27;)
						.position(&#x27;bottom&#x27;)
						.hideDelay(4000)
				);
			}

		};
	});
</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
