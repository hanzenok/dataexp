<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/rest/GetTimeseries.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: server/rest/GetTimeseries.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li></ul></li></ul></li></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li></ul></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>server/rest/GetTimeseries.js</h4>

<pre class="code prettyprint linenums">
var tsproc = require(&#x27;tsproc&#x27;);

/**
 * Rest API&#x27;s offered by server.
 * @module server
 * @submodule RestApi
 */

/**
 * @class GetTimseries
 */

//connectors
var mongo_connector = require(&#x27;../connectors/MongoConnector&#x27;);
var mysql_connector = require(&#x27;../connectors/MysqlConnector&#x27;);
var file_connector = require(&#x27;../connectors/FileConnector&#x27;);
var ConnectorsEnum = {
	
					&#x27;mongo&#x27;: mongo_connector,
					&#x27;mysql&#x27;: mysql_connector,
					&#x27;json&#x27;: file_connector,
					&#x27;csv&#x27;: file_connector
					};

//stats config
var stats = {};
stats.homogen = &#x27;?&#x27;;
stats.size = &#x27;?&#x27;;
stats.per_day = &#x27;?&#x27;;
stats.from = &#x27;&#x27;;
stats.to = &#x27;&#x27;;

//ts config
var config = {};

var TS = {};

//returns the data
TS.getTimeseries = function(req, res){

var config = {
        &quot;transform&quot;:{&quot;type&quot;:&quot;interp&quot;,&quot;interp_type&quot;:&quot;linear&quot;},

        &quot;reduction&quot;:{&quot;type&quot;:&quot;skip&quot;,&quot;size&quot;:1,&quot;target_field&quot;:&quot;&quot;},

        &quot;date_borders&quot;:{&quot;from&quot;:{&quot;date&quot;:&quot;&quot;},&quot;to&quot;:{&quot;date&quot;:&quot;&quot;}},

        &quot;correlation&quot;:{&quot;count_negative&quot;:false,&quot;max_coef&quot;:true},

        &quot;timeseries&quot;:
            [
                {
                &quot;fields&quot;:
                    [
                        {&quot;name&quot;:&quot;a&quot;, &quot;quantum&quot;: 2}  //new field
                    ],

                &quot;timestamp&quot;:{&quot;name&quot;:&quot;year&quot;,&quot;format&quot;:&quot;YYYY&quot;, &quot;quantum&quot;: &quot;none&quot;}
                },

                {
                &quot;fields&quot;:
                    [
                        {&quot;name&quot;:&quot;b&quot;, &quot;quantum&quot;: 2}  //new field
                    ],  

                &quot;timestamp&quot;:{&quot;name&quot;:&quot;year&quot;,&quot;format&quot;:&quot;YYYY&quot;, &quot;quantum&quot;: &quot;none&quot;}
                }
            ]
    };


var ts = [
        [{a: 21.07, year:&#x27;2012&#x27;}, {a: 23.23, year:&#x27;2013&#x27;}, {a: 0.24, year:&#x27;2014&#x27;}, {a: 25.25, year:&#x27;2015&#x27;}, {a: 25.25, year:&#x27;2016&#x27;}, {a: 25.25, year:&#x27;2017&#x27;}],
        [{b: 21.42, year:&#x27;2012&#x27;}, {b: 23.11, year:&#x27;2013&#x27;}, {b: 0.11, year:&#x27;2014&#x27;}, {b: 21.01, year:&#x27;2015&#x27;}, {b: 4.5, year:&#x27;2016&#x27;}, {b: 35.2, year:&#x27;2017&#x27;}]
     ];

var tsp = new tsproc(ts, config, null);

//we can just merge (without interpolation) the timeseries
//because they are homogeneous
tsp.merge();
tsp.toISO();


tsp.quantize(function(err, timeseries){

        if (timeseries) console.log(timeseries);
});


	//get the requested dataset
	var fields_config = req.body;

	//fields_config is an array of size 3
	//0 - config file
	//1 - timestamp fields
	//2 - other fields
	if(fields_config.length){

		//regroup the field from the same source
		var new_fields_config = regroupFields.call(this, fields_config);

		//options config
		var options = fields_config[0];

		if(!new_fields_config){

			res.status(500).send(&#x27;Some field(s) are missing the timestamp&#x27;);
			return;
		}

		//load all the data
		//from the specified sources
		var n = new_fields_config.length;
		var promises = new Array(n);
		for (var i=0; i&lt;n; i++){

			promises[i] = new Promise(function(resolve, reject){

				ConnectorsEnum[new_fields_config[i].source.type].getDataset(new_fields_config[i], function(error, dataset){

					if (dataset) resolve(dataset);
					if (error) reject(error);
				});
			});
		}

		//process the data
		Promise.all(promises)
		.then(function(datasets){

			//callback
			var callback = function(err, data){

				if (err) res.status(500).send(err.message);
				if (data) res.json(data);
			}

			//parse a config for tsproc
			//options
			var tsproc_config = {};
			var tmp;
			tsproc_config.transform = options.transform;
			tsproc_config.reduction = options.reduction;
			tsproc_config.date_borders = options.date_borders;
			tsproc_config.correlation = options.correlation;

			// //fields
			tsproc_config.timeseries = [];
			new_fields_config.forEach(function(config, index, array){

				tmp = {};
				tmp.fields = [];
				config.fields.forEach(function(field, ind){

					if (field.format){

						tmp.timestamp = field;
					}
					else{

						tmp.fields.push(field);
					}

				});

				tsproc_config.timeseries.push(tmp);
			});

			//save the config before using tsproc
			//cause tsproc will modify it
			config = JSON.parse(JSON.stringify(tsproc_config));

			//instantiate the timeseries processor
			var tsp = new tsproc(datasets, tsproc_config, callback);
			
			//generate a stats json
			//check the homgenity before the processing
			//(after the processing timeseries becomes homogeneous)
			//precutting to assure that the homogen value is accurate
			tsp.cut([tsproc_config.date_borders.from.date, tsproc_config.date_borders.to.date]);
			stats.homogen = tsp.isHomogeneous(); //check the 

			//process the timseries
			tsp.process(function(err, data){

				if (err) res.status(500).send(err.message);
			});

			//check the correlations
			//if size &gt; 3000 means using
			//Canvas.js on backend, so
			//a graph chart doesn&#x27;t have
			//a scroll chart to visualise the correlations
			if (tsp.getTSSize() &lt;= 3000){

				tsp.checkSimilarity(callback);
			}
			else{

				//return a timeseries
				tsp.getTS(callback);
			}

			//get the other stats
			var borders = tsp.getBorders();
			stats.from = borders[0];
			stats.to = borders[1];
			stats.size = tsp.getTSSize();
			stats.per_day = tsp.getAvgPerDay();
		})
		.catch(function(error){

			res.status(500).send(error.message);	
		});
	}
}

//returns the stats
//that were generated in the getTimeseries() function
TS.getStats = function(req, res){
	
	res.json([stats]);
}

TS.getConfig = function(req, res){

	res.json([config]);
}

//used to regroup fields of the same 
//store into one config
function regroupFields(configs){

	var timestamps = configs[1];
	var fields = configs[2];
	var n = timestamps.length;	
	var m = fields.length;

	var new_configs = new Array(n);
	var tmp;

	//prepare the timestamp fields
	timestamps.forEach(function(timestamp_config, index){

		tmp = {};
		tmp.fields = [];

		//copy the timestamp
		tmp.fields.push(timestamp_config.field);

		//and other info
		tmp.store = timestamp_config.store;
		tmp.source = timestamp_config.source;

		//add to the new config
		new_configs[index] = tmp;
	});


	//regroup the other fields
	var count_fields = 0;
	for (var i=0; i&lt;n; i++){

		for (var j=0; j&lt;m; j++){

			if (new_configs[i].source.name === fields[j].source.name &amp;&amp;
				new_configs[i].store.name === fields[j].store.name){

				new_configs[i].fields.push(fields[j].field);
				count_fields++;
			}
		}
	}

	//check if all timestamps have their
	//field associated
	for (var i=0; i&lt;n; i++){

		if (new_configs[i].fields.length &lt;= 1)
			return null;
	}

	//check if all fields were assciated
	//with a timestamp field:
	if (count_fields != m){

		return null;
	}

	return new_configs;
}

module.exports = TS;
</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
