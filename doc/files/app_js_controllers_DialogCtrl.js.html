<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/controllers/DialogCtrl.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: app/js/controllers/DialogCtrl.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/DeleteSource.html">DeleteSource</a></li>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetFields.html">GetFields</a></li>
                            <li><a href="../classes/GetSources.html">GetSources</a></li>
                            <li><a href="../classes/GetStores.html">GetStores</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                            <li><a href="../classes/PutSource.html">PutSource</a></li>
                            <li><a href="../classes/routes.html">routes</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li></ul></li></ul></li></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_DeleteSource.js.html">DeleteSource.js</a></li><li><a href="../files/server_rest_GetFields.js.html">GetFields.js</a></li><li><a href="../files/server_rest_GetSources.js.html">GetSources.js</a></li><li><a href="../files/server_rest_GetStores.js.html">GetStores.js</a></li><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li><li><a href="../files/server_rest_PutSource.js.html">PutSource.js</a></li></ul></li><li><a href="../files/server_routes.js.html">routes.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/js/controllers/DialogCtrl.js</h4>

<pre class="code prettyprint linenums">
angular.module(&#x27;MainApp&#x27;)
	.controller(&#x27;DialogCtrl&#x27;, function($scope, $rootScope, $mdDialog, $mdToast, SourcesService, CSV2JSONService){

		/*******AddSource.html********/
		$scope.showHints = false; //managin the error hints

		//deletable if dialog gives the possibility
		//to modify the existing source
		//false if adding a new source (via fab button)
		$scope.deletable = true;

		//if adding the new source,
		//initialase the source_conf
		if (!$scope.source_conf){

			$scope.source_conf = {

				source:{
					name: &#x27;&#x27;,
					type: &#x27;mongo&#x27;,
					user: &#x27;&#x27;,
					passw: &#x27;&#x27;,
					server: &#x27;localhost&#x27;,
					port: null,
					db:&#x27;&#x27;,
					wanted: false
				}
			};

			$scope.deletable = false;
		}

		//save the initial value of source_conf
		//to detect if it was modified
		var old_source_conf = null;
		if ($scope.deletable){
			
			old_source_conf = JSON.parse(JSON.stringify($scope.source_conf));
		}

		$scope.getToolbarTitle = function(){

			if ($scope.deletable)
				return &#x27;Modifying a source&#x27;;
			else
				return &#x27;Adding a new source&#x27;;
		}

		$scope.getButtonLabel = function(){

			if ($scope.deletable)
				return &#x27;Modify&#x27;;
			else
				return &#x27;Save&#x27;;
		}

		$scope.connect = function() {
			
			$scope.showHints = true;
			
			console.log(&#x27;DialogController:&#x27;);
			console.log($scope.source_conf);

			//if we are modifying the existing source
			if ($scope.deletable){

				//if the source was modified
				if (JSON.stringify($scope.source_conf) !== JSON.stringify(old_source_conf)){

					//if all the inputs are specified
					if ($scope.source_conf.source.name &amp;&amp; $scope.source_conf.source.type &amp;&amp; 
					$scope.source_conf.source.server &amp;&amp; $scope.source_conf.source.db){

						//modify the source in the backend
						//var wanted = $scope.source_conf.source.wanted;
						SourcesService.modify($scope.source_conf, 
							function(result){

								//reload sources, clear all
								$rootScope.loadSources();
								$rootScope.clearStores();
								$rootScope.clearFields();

								$mdDialog.hide();

							},
							function(err){

								$mdDialog.hide();
								if (!err.data) err.data = &#x27;Server is unreachable&#x27;;

								$mdToast.show(
									$mdToast.simple()
										.textContent(err.data)
										.action(&#x27;OK&#x27;)
										.position(&#x27;bottom&#x27;)
										.hideDelay(4000)
								);
							}
						);						
					}
				}
				//the source was not modified
				//close the dialog
				else{

					$mdDialog.hide();
				}
			}
			//if we are adding a new source
			else{

				console.log(&#x27;not deletable!!&#x27;);

				//if all the inputs are specified
				if ($scope.source_conf.source.name &amp;&amp; $scope.source_conf.source.type &amp;&amp; 
					$scope.source_conf.source.server &amp;&amp; $scope.source_conf.source.db){

					SourcesService.post($scope.source_conf, 
						function(result){

							//reload sources, clear all
							$rootScope.loadSources();
							$rootScope.clearStores();
							$rootScope.clearFields();

							$mdDialog.hide();

						},
						function(err){

							$mdDialog.hide();
							if (!err.data) err.data = &#x27;Server is unreachable&#x27;;


							$mdToast.show(
								$mdToast.simple()
									.textContent(err.data)
									.action(&#x27;OK&#x27;)
									.position(&#x27;bottom&#x27;)
									.hideDelay(4000)
							);
						}
					);
				}
				//not all fields are specified
				//show the error hints
				else{
					console.log(&#x27;here1&#x27;);
					$scope.showHints = true;
				}
			}
		};

		$scope.deleteSource = function(){

			console.log(&#x27;delete!!&#x27;);
			console.log($scope.source_conf);
			SourcesService.delete($scope.source_conf.source.name, 
				function(){

					//reload sources, clear all
					$rootScope.loadSources();
					$rootScope.clearStores();
					$rootScope.clearFields();

					$mdDialog.hide();
				},
				function(err){

					$mdDialog.hide();
					if (!err.data) err.data = &#x27;Server is unreachable&#x27;;


					$mdToast.show(
						$mdToast.simple()
							.textContent(err.data)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);
				}
			);
		}

		/*******SaveFormat.html********/
		$scope.format = &#x27;ISO&#x27;;
		$scope.saveFormat = function(){
			
			$mdDialog.hide($scope.format);
		};

		/***********Both***********/
		$scope.cancel = function() {

			$mdDialog.cancel();
		};

		//reads the file choosed in the 
		//file dialog and saves it in the backend
		//finally, closes the dialog
		$scope.saveSourceFile = function(element){

			//if the file was specified
			if ($scope.source_conf.source.name) {

				//get the file (only one)
				var file = element.files[0];

				//check the type
				if (file.type.split(&#x27;/&#x27;)[1] !== $scope.source_conf.source.type){

					$mdDialog.hide();

					$mdToast.show(
						$mdToast.simple()
							.textContent(&#x27;Incorrect file extension&#x27;)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);

					return;
				}
		
				//file reader
				var reader = new FileReader();
				reader.onload = function(e){

					var data = e.target.result;

					//mark the &#x27;server&#x27; and &#x27;db&#x27; of the source
					$scope.source_conf.source.db = file.name;
					$scope.source_conf.source.server = &#x27;file&#x27;;

					//send the dataset to the server
					var dataset = {};
					dataset.name = $scope.source_conf.source.name;
					dataset.data = ($scope.source_conf.source.type === &#x27;json&#x27;) ? JSON.parse(data) : CSV2JSONService.csv2json(data);
					SourcesService.post(dataset, function(res){}, function(err){});

					//simulates a click on the &quot;Save&quot; button
					$scope.connect.call(this);
				}

				//read the file
				reader.readAsText(file);
			}
		}

	});


</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
