<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/controllers/DialogCtrl.js - dataexp</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">dataexp: app/js/controllers/DialogCtrl.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/client.html">client</a>
                                <ul>
                                        <li><a href="../modules/client.html#Controllers">Controllers</a></li>
                                        <li><a href="../modules/client.html#Services">Services</a></li>
                                </ul>
                            </li>
                            <li><a href="../modules/server.html">server</a>
                                <ul>
                                        <li><a href="../modules/server.html#Connectors">Connectors</a></li>
                                        <li><a href="../modules/server.html#RestApi">RestApi</a></li>
                                </ul>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/CanvasChartsService.html">CanvasChartsService</a></li>
                            <li><a href="../classes/ChartsCtrl.html">ChartsCtrl</a></li>
                            <li><a href="../classes/DCChartsService.html">DCChartsService</a></li>
                            <li><a href="../classes/DeleteSource.html">DeleteSource</a></li>
                            <li><a href="../classes/DeleteZoneCtrl.html">DeleteZoneCtrl</a></li>
                            <li><a href="../classes/DialogCtrl.html">DialogCtrl</a></li>
                            <li><a href="../classes/FabCtrl.html">FabCtrl</a></li>
                            <li><a href="../classes/FieldsService.html">FieldsService</a></li>
                            <li><a href="../classes/FileConnector.html">FileConnector</a></li>
                            <li><a href="../classes/GetFields.html">GetFields</a></li>
                            <li><a href="../classes/GetSources.html">GetSources</a></li>
                            <li><a href="../classes/GetStores.html">GetStores</a></li>
                            <li><a href="../classes/GetTimseries.html">GetTimseries</a></li>
                            <li><a href="../classes/HideBtnCtrl.html">HideBtnCtrl</a></li>
                            <li><a href="../classes/LeftNavCtrl.html">LeftNavCtrl</a></li>
                            <li><a href="../classes/LoaderCtrl.html">LoaderCtrl</a></li>
                            <li><a href="../classes/main.html">main</a></li>
                            <li><a href="../classes/MongoConnector.html">MongoConnector</a></li>
                            <li><a href="../classes/MovableChartsCtrl.html">MovableChartsCtrl</a></li>
                            <li><a href="../classes/MysqlConnector.html">MysqlConnector</a></li>
                            <li><a href="../classes/PutSource.html">PutSource</a></li>
                            <li><a href="../classes/RightNavCtrl.html">RightNavCtrl</a></li>
                            <li><a href="../classes/routes.html">routes</a></li>
                            <li><a href="../classes/server.html">server</a></li>
                            <li><a href="../classes/SourcesService.html">SourcesService</a></li>
                            <li><a href="../classes/StoresService.html">StoresService</a></li>
                            <li><a href="../classes/TimeseriesService.html">TimeseriesService</a></li>
                            <li><a href="../classes/ToolBarCtrl.html">ToolBarCtrl</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>js/<ul><li><a href="../files/app_js_canvasjs.js.html">canvasjs.js</a></li><li>controllers/<ul><li><a href="../files/app_js_controllers_ChartsCtrl.js.html">ChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_DeleteZoneCtrl.js.html">DeleteZoneCtrl.js</a></li><li><a href="../files/app_js_controllers_DialogCtrl.js.html">DialogCtrl.js</a></li><li><a href="../files/app_js_controllers_FabCtrl.js.html">FabCtrl.js</a></li><li><a href="../files/app_js_controllers_HideBtnCtrl.js.html">HideBtnCtrl.js</a></li><li><a href="../files/app_js_controllers_LeftNavCtrl.js.html">LeftNavCtrl.js</a></li><li><a href="../files/app_js_controllers_LoaderCtrl.js.html">LoaderCtrl.js</a></li><li><a href="../files/app_js_controllers_MovableChartsCtrl.js.html">MovableChartsCtrl.js</a></li><li><a href="../files/app_js_controllers_RightNavCtrl.js.html">RightNavCtrl.js</a></li><li><a href="../files/app_js_controllers_ToolBarCtrl.js.html">ToolBarCtrl.js</a></li></ul></li><li><a href="../files/app_js_main.js.html">main.js</a></li><li>services/<ul><li><a href="../files/app_js_services_CanvasChartsService.js.html">CanvasChartsService.js</a></li><li><a href="../files/app_js_services_DCChartsService.js.html">DCChartsService.js</a></li><li><a href="../files/app_js_services_FieldsService.js.html">FieldsService.js</a></li><li><a href="../files/app_js_services_SourcesService.js.html">SourcesService.js</a></li><li><a href="../files/app_js_services_StoresService.js.html">StoresService.js</a></li><li><a href="../files/app_js_services_TimeseriesService.js.html">TimeseriesService.js</a></li></ul></li></ul></li></ul></li><li>server.js/<ul></ul></li><li>server/<ul><li>connectors/<ul><li><a href="../files/server_connectors_FileConnector.js.html">FileConnector.js</a></li><li><a href="../files/server_connectors_MongoConnector.js.html">MongoConnector.js</a></li><li><a href="../files/server_connectors_MysqlConnector.js.html">MysqlConnector.js</a></li></ul></li><li>rest/<ul><li><a href="../files/server_rest_DeleteSource.js.html">DeleteSource.js</a></li><li><a href="../files/server_rest_GetFields.js.html">GetFields.js</a></li><li><a href="../files/server_rest_GetSources.js.html">GetSources.js</a></li><li><a href="../files/server_rest_GetStores.js.html">GetStores.js</a></li><li><a href="../files/server_rest_GetTimeseries.js.html">GetTimeseries.js</a></li><li><a href="../files/server_rest_PutSource.js.html">PutSource.js</a></li></ul></li><li><a href="../files/server_routes.js.html">routes.js</a></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/js/controllers/DialogCtrl.js</h4>

<pre class="code prettyprint linenums">
/**
 * Angualr.js controllers.
 * @module client
 * @submodule Controllers
 */

/**
 * A controller that serves the two templates
 * for dialog windows: &lt;code&gt;AddSource.html&lt;/code&gt;
 * and &lt;code&gt;SaveFormat.html&lt;/code&gt;.
 * &lt;br/&gt;
 * It uses two custom angular services:
 * - &lt;b&gt;SourcesService&lt;/b&gt;: deals with getting/sendig/adding/deleting sources from/to/to/from the backend
 * - &lt;b&gt;CSV2JSONService&lt;/b&gt;: used for csv type sources
 * @class DialogCtrl
 */
angular.module(&#x27;MainApp&#x27;)
	.controller(&#x27;DialogCtrl&#x27;, function($scope, $rootScope, $mdDialog, $mdToast, SourcesService, CSV2JSONService){

		//===========================//
		/*******AddSource.html********/
		//===========================//

		/**
		* @property showHints
		* @type boolean
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable
		* that manages the error
		* hints in a form at &lt;code&gt;AddSource.html&lt;/code&gt;
		* dialog.
		*/
		$scope.showHints = false;

		/**
		* @property deletable
		* @type boolean
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable
		* that defines wheather the &lt;code&gt;AddSource.html&lt;/code&gt;
		* is used for adding a new source or for modifying 
		* the existing one.
		* &lt;br/&gt;
		* &lt;code&gt;$scope.deletable&lt;/code&gt; is &lt;b&gt;true&lt;/b&gt; if 
		* the source is modifyable.
		*/
		$scope.deletable = true;

		/**
		* @property source_conf
		* @type json
		* @description A &lt;b&gt;local scope&lt;/b&gt; variable
		* that holds the source config.
		* &lt;br/&gt;
		* Binded to the &lt;code&gt;AddSource.html&lt;/code&gt; dialog.
		*/
		if (!$scope.source_conf){

			$scope.source_conf = {

				source:{
					name: &#x27;&#x27;,
					type: &#x27;mongo&#x27;,
					user: &#x27;&#x27;,
					passw: &#x27;&#x27;,
					server: &#x27;localhost&#x27;,
					port: null,
					db:&#x27;&#x27;,
					wanted: false
				}
			};

			$scope.deletable = false;
		}

		//save the initial value of source_conf
		//to detect if it was modified
		var old_source_conf = null;
		if ($scope.deletable){
			
			old_source_conf = JSON.parse(JSON.stringify($scope.source_conf));
		}

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method
		* that returns the title of a toolbar.
		* &lt;br/&gt;
		* Its value depends on wheather or not 
		* the &lt;code&gt;AddSource.html&lt;/code&gt; dialog was called to add or modify a source.
		* @method getToobarTitle
		* @return {string} A toolbar title
		*/
		$scope.getToolbarTitle = function(){

			if ($scope.deletable)
				return &#x27;Modifying a source&#x27;;
			else
				return &#x27;Adding a new source&#x27;;
		}

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method
		* that returns the label of the OK button
		* in the  dialog.
		* &lt;br/&gt;
		* Its value depends on wheather or not 
		* the &lt;code&gt;AddSource.html&lt;/code&gt; dialog was called to add or modify a source.
		* @method getButtonLabel
		* @return {string} A button label
		*/
		$scope.getButtonLabel = function(){

			if ($scope.deletable)
				return &#x27;Modify&#x27;;
			else
				return &#x27;Save&#x27;;
		}

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method, attached to 
		* the OK button in the &lt;code&gt;AddSource.html&lt;/code&gt; dialog, that
		* uses services &lt;b&gt;SourcesService&lt;/b&gt; and
		* &lt;b&gt;CSV2JSONService&lt;/b&gt; to add or modify a source in the back-end.
		* @method connect
		*/
		$scope.connect = function() {
			
			$scope.showHints = true;

			//if we are modifying the existing source
			if ($scope.deletable){

				//if the source was modified
				if (JSON.stringify($scope.source_conf) !== JSON.stringify(old_source_conf)){

					//if all the inputs are specified
					if ($scope.source_conf.source.name &amp;&amp; $scope.source_conf.source.type &amp;&amp; 
					$scope.source_conf.source.server &amp;&amp; $scope.source_conf.source.db){

						//modify the source in the backend
						//var wanted = $scope.source_conf.source.wanted;
						SourcesService.modify($scope.source_conf, 
							function(result){

								//reload sources, clear all
								$rootScope.loadSources();
								$rootScope.clearStores();
								$rootScope.clearFields();

								$mdDialog.hide();

							},
							function(err){

								$mdDialog.hide();
								if (!err.data) err.data = &#x27;Server is unreachable&#x27;;

								$mdToast.show(
									$mdToast.simple()
										.textContent(err.data)
										.action(&#x27;OK&#x27;)
										.position(&#x27;bottom&#x27;)
										.hideDelay(4000)
								);
							}
						);						
					}
				}
				//the source was not modified
				//close the dialog
				else{

					$mdDialog.hide();
				}
			}
			//if we are adding a new source
			else{

				//if all the inputs are specified
				if ($scope.source_conf.source.name &amp;&amp; $scope.source_conf.source.type &amp;&amp; 
					$scope.source_conf.source.server &amp;&amp; $scope.source_conf.source.db){

					SourcesService.send($scope.source_conf, 
						function(result){

							//reload sources, clear all
							$rootScope.loadSources();
							$rootScope.clearStores();
							$rootScope.clearFields();

							$mdDialog.hide();

						},
						function(err){

							$mdDialog.hide();
							if (!err.data) err.data = &#x27;Server is unreachable&#x27;;


							$mdToast.show(
								$mdToast.simple()
									.textContent(err.data)
									.action(&#x27;OK&#x27;)
									.position(&#x27;bottom&#x27;)
									.hideDelay(4000)
							);
						}
					);
				}
				//not all fields are specified
				//show the error hints
				else{
					$scope.showHints = true;
				}
			}
		};

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method, attached 
		* to the delete button in the toolbar of the 
		* &lt;code&gt;AddSource.html&lt;/code&gt; dialog, that uses 
		* a service &lt;b&gt;SourcesService&lt;/b&gt; to delete a source from the
		* back-end.
		* @method deleteSource
		*/
		$scope.deleteSource = function(){

			SourcesService.delete($scope.source_conf.source.name, 
				function(){

					//reload sources, clear all
					$rootScope.loadSources();
					$rootScope.clearStores();
					$rootScope.clearFields();

					$mdDialog.hide();
				},
				function(err){

					$mdDialog.hide();
					if (!err.data) err.data = &#x27;Server is unreachable&#x27;;


					$mdToast.show(
						$mdToast.simple()
							.textContent(err.data)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);
				}
			);
		}

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that serves &lt;code&gt;AddSource.html&lt;/code&gt; 
		* and reads the choosen file on front-end 
		* and saves it on the back-end.
		* &lt;br/&gt;
		* Called when the added source is of the 
		* &#x27;file&#x27; type (JSON or CSV).
		* @method saveSourceFile
		* @param element Used to get the choosen file on the front-end
		*/
		$scope.saveSourceFile = function(element){

			//if the file was specified
			if ($scope.source_conf.source.name) {

				//get the file (only one)
				var file = element.files[0];

				//check the type
				if (file.type.split(&#x27;/&#x27;)[1] !== $scope.source_conf.source.type){

					$mdDialog.hide();

					$mdToast.show(
						$mdToast.simple()
							.textContent(&#x27;Incorrect file extension&#x27;)
							.action(&#x27;OK&#x27;)
							.position(&#x27;bottom&#x27;)
							.hideDelay(4000)
					);

					return;
				}
		
				//file reader
				var reader = new FileReader();
				reader.onload = function(e){

					var data = e.target.result;

					//mark the &#x27;server&#x27; and &#x27;db&#x27; of the source
					$scope.source_conf.source.db = file.name;
					$scope.source_conf.source.server = &#x27;file&#x27;;

					//send the dataset to the server
					var dataset = {};
					dataset.name = $scope.source_conf.source.name;
					dataset.data = ($scope.source_conf.source.type === &#x27;json&#x27;) ? JSON.parse(data) : CSV2JSONService.csv2json(data);
					SourcesService.send(dataset, function(res){}, function(err){});

					//simulates a click on the &quot;Save&quot; button
					$scope.connect.call(this);
				}

				//read the file
				reader.readAsText(file);
			}
		}

		//============================//
		/*******SaveFormat.html********/
		//============================//

		/**
		 * @property format
		 * @type string
		 * @description A &lt;b&gt;local scope&lt;/b&gt; variable
		 * that is binded to the &lt;code&gt;SaveFormat.html&lt;/code&gt;
		 * dialog and holds the choosen timestamp format.
		 * &lt;br/&gt;
		 * The default value is &#x27;ISO&#x27; (ISO8601).
		 */
		$scope.format = &#x27;ISO&#x27;; //the default format

		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that serves
		* &lt;code&gt;SaveFormat.html&lt;/code&gt; dialog and saves
		* the the timestamp format specified by user.
		* &lt;br/&gt;
		* It is done by calling the method &lt;code&gt;hide()&lt;/code&gt;
		* of &lt;b&gt;$mdDialog&lt;/b&gt; service and passing it the format.
		* This way the format can be grabbed in the &lt;code&gt;.then()&lt;/code&gt;
		* method in the controller &lt;b&gt;LoaderCtrl&lt;/b&gt;.
		* @method saveFormat
		*/
		$scope.saveFormat = function(){
			
			$mdDialog.hide($scope.format);
		};

		/***********Both***********/
		/**
		* A &lt;b&gt;local scope&lt;/b&gt; method that serves 
		* the &lt;code&gt;AddSource.html&lt;/code&gt; and &lt;code&gt;SaveFormat.html&lt;/code&gt;
		* dialogs and is used to close the dialog.
		* &lt;br/&gt;
		* Done by calling the &lt;code&gt;cancel()&lt;/code&gt; method
		* of &lt;b&gt;$mdDialog&lt;/b&gt; service.
		* @method cancel
		*/
		$scope.cancel = function() {

			$mdDialog.cancel();
		};

	});


</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
